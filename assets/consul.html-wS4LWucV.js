import{_ as t}from"./plugin-vue_export-helper-x3n3nnut.js";import{r as p,o,c,a as s,b as n,d as i,e as a}from"./app--gZc9Umm.js";const l="/images/consul-start.png",u="/images/consul-register.png",r={},d=a('<h1 id="_1-背景" tabindex="-1"><a class="header-anchor" href="#_1-背景" aria-hidden="true">#</a> 1.背景</h1><p>由于基金筛选系统和组合管理系统间存在一些互相需要使用到的基础数据，但又不想重复创建数据库表单和同步数据，因此在两个项目中使用了grpc来实现数据调用；早期实现的grpc版本中直接使用对方的IP和端口，每次调整或部署到其他地方都需要修改代码，因此考虑使用服务注册和发现来解决这个问题。</p><p>对比了<strong>etcd</strong>和<strong>consul</strong>两个方案，由于后端使用的语言是python，而etcd的版本比较多，导致相关的库也需要对应版本，使用起来比较麻烦，因此最终使用consul和对应的库<code>python-consul</code>。</p><h1 id="_2-安装与启动" tabindex="-1"><a class="header-anchor" href="#_2-安装与启动" aria-hidden="true">#</a> 2.安装与启动</h1><h2 id="_2-1安装" tabindex="-1"><a class="header-anchor" href="#_2-1安装" aria-hidden="true">#</a> 2.1安装</h2>',5),k={href:"https://www.consul.io/",target:"_blank",rel:"noopener noreferrer"},v=a(`<div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>$ <span class="token builtin class-name">cd</span>  /home/downloads
$ <span class="token function">mkdir</span> consul <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">cd</span> consul
$ <span class="token function">wget</span> https://releases.hashicorp.com/consul/1.9.5/consul_1.9.5_linux_amd64.zip
$ <span class="token function">unzip</span> consul_1.9.5_linux_amd64.zip
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_2-2启动" tabindex="-1"><a class="header-anchor" href="#_2-2启动" aria-hidden="true">#</a> 2.2启动</h2><p>以刚刚下载的文件为例：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>$ ./consul agent <span class="token parameter variable">-server</span> -bootstrap-expect <span class="token number">1</span> -data-dir<span class="token operator">=</span>/tmp/consul <span class="token parameter variable">-node</span><span class="token operator">=</span>n1 <span class="token parameter variable">-bind</span><span class="token operator">=</span><span class="token number">127.0</span>.0.1 <span class="token parameter variable">-client</span><span class="token operator">=</span><span class="token number">0.0</span>.0.0 <span class="token parameter variable">-ui</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>默认使用端口<code>8500</code>，在浏览器中输入服务器<code>{ip}:8500</code>即可通过web查看注册的服务了，当然目前只有一个默认的健康检测服务。</p><figure><img src="`+l+`" alt="启动页面" tabindex="0" loading="lazy"><figcaption>启动页面</figcaption></figure><h1 id="_3-在python中使用" tabindex="-1"><a class="header-anchor" href="#_3-在python中使用" aria-hidden="true">#</a> 3.在Python中使用</h1><p>首先需要安装<code>python-consul</code>库：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>$ pip3 <span class="token function">install</span> python-consul
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>简单示例：</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code><span class="token comment">#test.py</span>
<span class="token keyword">import</span> consul


<span class="token keyword">class</span> <span class="token class-name">Consul</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> host<span class="token operator">=</span><span class="token string">&#39;10.170.139.10&#39;</span><span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">8500</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>_consul <span class="token operator">=</span> consul<span class="token punctuation">.</span>Consul<span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">register</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">,</span> host<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;注册服务&quot;&quot;&quot;</span>
        self<span class="token punctuation">.</span>_consul<span class="token punctuation">.</span>agent<span class="token punctuation">.</span>service<span class="token punctuation">.</span>register<span class="token punctuation">(</span>
            name<span class="token operator">=</span>name<span class="token punctuation">,</span> service_id<span class="token operator">=</span>name<span class="token punctuation">,</span> address<span class="token operator">=</span>host<span class="token punctuation">,</span> port<span class="token operator">=</span>port<span class="token punctuation">,</span>
            check<span class="token operator">=</span>consul<span class="token punctuation">.</span>Check<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>tcp<span class="token punctuation">(</span>host<span class="token operator">=</span>host<span class="token punctuation">,</span> port<span class="token operator">=</span>port<span class="token punctuation">,</span> interval<span class="token operator">=</span><span class="token string">&#39;5s&#39;</span><span class="token punctuation">,</span>
                                     timeout<span class="token operator">=</span><span class="token string">&#39;30s&#39;</span><span class="token punctuation">,</span> deregister<span class="token operator">=</span><span class="token string">&#39;30s&#39;</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">find</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;发现服务&quot;&quot;&quot;</span>
        services <span class="token operator">=</span> self<span class="token punctuation">.</span>_consul<span class="token punctuation">.</span>agent<span class="token punctuation">.</span>services<span class="token punctuation">(</span><span class="token punctuation">)</span>
        server <span class="token operator">=</span> services<span class="token punctuation">.</span>get<span class="token punctuation">(</span>name<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> server<span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token boolean">False</span>
        addr <span class="token operator">=</span> server<span class="token punctuation">[</span><span class="token string">&#39;Address&#39;</span><span class="token punctuation">]</span>
        port <span class="token operator">=</span> server<span class="token punctuation">[</span><span class="token string">&#39;Port&#39;</span><span class="token punctuation">]</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>addr<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">True</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">&#39;__main__&#39;</span><span class="token punctuation">:</span>
    c <span class="token operator">=</span> Consul<span class="token punctuation">(</span><span class="token punctuation">)</span>
    c<span class="token punctuation">.</span>register<span class="token punctuation">(</span><span class="token string">&#39;fund_filter_django&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;10.170.139.10&#39;</span><span class="token punctuation">,</span> <span class="token number">50051</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">&#39;fund_filter_django&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>执行文件可以看到：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>$ python3 test.py
<span class="token punctuation">((</span><span class="token string">&#39;10.170.139.10&#39;</span>, <span class="token number">50051</span><span class="token punctuation">)</span>, True<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>查看web页面可以看到：</p><figure><img src="`+u+'" alt="注册服务" tabindex="0" loading="lazy"><figcaption>注册服务</figcaption></figure>',15);function m(b,h){const e=p("ExternalLinkIcon");return o(),c("div",null,[d,s("p",null,[n("直接前往 "),s("a",k,[n("Consul by HashiCorp"),i(e)]),n(" 官网下载对应系统的可执行文件即可，以Linux为例")]),v])}const f=t(r,[["render",m],["__file","consul.html.vue"]]);export{f as default};
